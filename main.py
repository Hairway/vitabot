import telebot
import schedule
import time
from threading import Thread
import json
import random

# –í–∞—à —Ç–æ–∫–µ–Ω –æ—Ç BotFather
TOKEN = '7598457393:AAGYDyzb67hgudu1e1wPiqet0imV-F6ZCiI'

# –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
bot = telebot.TeleBot(TOKEN)

# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–∞—Ç–∞ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç–µ—Å—Ç–∞
last_chat_id = None
test_mode = False
user_states = {}

# –°–æ–æ–±—â–µ–Ω–∏—è-–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
reminder_messages = [
    "–ö–æ—Ç–∫–∞, –ø–æ—Ä–∞ —Å–¥–µ–ª–∞—Ç—å –ø–∞—Ä—É –≥–ª–æ—Ç–æ—á–∫–æ–≤ –≤–æ–¥—ã! üíß",
    "–ü—Ä–æ–≤–µ—Ä—å, –ø–æ–ª–Ω—ã–π –ª–∏ —É —Ç–µ–±—è —Å—Ç–∞–∫–∞–Ω. –ï—Å–ª–∏ –Ω–µ—Ç, —Ç–æ –ø–æ–ø—Ä–æ—Å–∏ –º–µ–Ω—è, –µ—Å–ª–∏ —è –¥–æ–º–∞. –Ø –ø—Ä–∏–Ω–µ—Å—É –∏ –Ω–∞–¥–æ –±—É–¥–µ—Ç –ø–æ–ø–∏—Ç—åüíß",
    "–õ—é–±–æ—á–∫–∞, –≤–æ–¥–∏—á–∫–∞ —Å—Ç–æ–∏—Ç –≤–æ–∑–ª–µ —Ç–µ–±—è –∏ –Ω–∞–¥–æ –ø–æ–ø–∏—Ç—å!üíß",
    "–í—Ä–µ–º—è –æ—Ç–æ—Ä–≤–∞—Ç—å—Å—è –æ—Ç —Ä–∞–±–æ—Ç—ã, –Ω–µ–º–Ω–æ–≥–æ –≤—ã–¥–æ—Ö–Ω—É—Ç—å –∏ –ø–æ–ø–∏—Ç—å –≤–æ–¥—ã! üíß",
    "–ï—Å–ª–∏ —Å–µ–π—á–∞—Å –ø–æ–ø–∏—Ç—å –≤–æ–¥—ã, —Ç–æ —Ç–≤–æ–π –ª—é–±–∏–º—ã–π –∫–æ—Ç–∫–∞ —Å—Ç–∞–Ω–µ—Ç —Å—á–∞—Å—Ç–ª–∏–≤–µ–µ! üíß",
    "–ö–æ—Ç–∞, –Ω–µ –∂—É–ª—å–Ω–∏—á–∞–π! –°–¥–µ–ª–∞–π –≥–ª–æ—Ç–æ—á–µ–∫ –∏ –Ω–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—Éüíß"
]

# –°–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–∞–±–ª–µ—Ç–∫–µ
tablet_message = "–ê –µ—â—ë, –∫–æ—Ç–∫–∞, —É–∂–µ –≤—Ä–µ–º—è –≤—ã–ø–∏—Ç—å —Ç–∞–±–ª–µ—Ç–∫—É! –ü–æ–ø—Ä–æ—Å–∏ –º–µ–Ω—è –∏ —è –ø—Ä–∏–Ω–µ—Å—É üíä"

# –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
last_reminder_message = None

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
def load_user_states():
    global user_states
    try:
        with open('user_state.json', 'r') as f:
            user_states = json.load(f)
    except FileNotFoundError:
        user_states = {}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
def save_user_states():
    with open('user_state.json', 'w') as f:
        json.dump(user_states, f)

# –ö–æ–º–∞–Ω–¥–∞ /start
@bot.message_handler(commands=['start'])
def start_message(message):
    global last_chat_id
    last_chat_id = message.chat.id
    bot.send_message(last_chat_id, "–ö–æ—Ç–∫–∞, –ø—Ä–∏–≤–µ—Ç! –Ø —Ç–µ–±—è –æ—á–µ–Ω—å –ª—é–±–ª—é ‚ù§Ô∏è \n\n"
                                    "–Ø —Å—Ç–∞—Ä–∞—é—Å—å —Å–ª–µ–¥–∏—Ç—å –∑–∞ —Ç–µ–º, —á—Ç–æ–±—ã —Ç—ã —á–∞—â–µ –ø–∏–ª–∞ –≤–æ–¥–∏—á–∫—É, –Ω–æ –ø–æ–¥—É–º–∞–ª, —á—Ç–æ –º–æ–≥—É –≤—ã–π—Ç–∏ –∏–∑ –¥–æ–º–∞, –±—ã—Ç—å –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ –∏–ª–∏ –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å—Å—è, –∏–ª–∏ –∑–∞—É—á–∏—Ç—å—Å—è.\n\n"
                                    "–ü–æ—ç—Ç–æ–º—É —è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –Ω–∞–ø–∏—Å–∞–ª —ç—Ç–æ—Ç —Ç–µ–ª–µ–≥—Ä–∞–º –±–æ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å —Ç–µ–±–µ –æ–± —ç—Ç–æ–º üòÅ\n\n"
                                    "–ö–∞–∂–¥—ã–π –±—É–¥–Ω–∏–π –¥–µ–Ω—å —Å 10 –¥–æ 8 –≤–µ—á–µ—Ä–∞ –æ–Ω –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–µ–±–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –ø–æ—Ä–∞ —Å–¥–µ–ª–∞—Ç—å —Ö–æ—Ç—è –±—ã –ø–∞—Ä—É –≥–ª–æ—Ç–æ—á–∫–æ–≤) –ù–∞–¥–æ —Ç–æ–ª—å–∫–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å, —á—Ç–æ —Ç—ã –ø–æ–ø–∏–ª–∞. –ù–æ –Ω–µ –∂—É–ª—å–Ω–∏—á–∞–π!\n\n"
                                    "–ê –µ—Å–ª–∏ —Ç—ã –±—É–¥–µ—à—å –µ–≥–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å (–∞ –Ω–µ –Ω–∞–¥–æ), —Ç–æ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç –æ–Ω –±—É–¥–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å —Ç–µ–±–µ –≤–Ω–æ–≤—å)))")

# –ö–æ–º–∞–Ω–¥–∞ /test
@bot.message_handler(commands=['test'])
def test_mode_start(message):
    global test_mode
    test_mode = True
    bot.send_message(message.chat.id, "–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! –°–µ–π—á–∞—Å –æ—Ç–ø—Ä–∞–≤–ª—é –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è...")
    send_water_reminder()
    send_tablet_reminder()

# –ö–æ–º–∞–Ω–¥–∞ /testend
@bot.message_handler(commands=['testend'])
def test_mode_end(message):
    global test_mode
    test_mode = False
    bot.send_message(message.chat.id, "–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –∑–∞–≤–µ—Ä—à–µ–Ω. –ë–æ—Ç –≤–µ—Ä–Ω—É–ª—Å—è –∫ –æ–±—ã—á–Ω–æ–º—É —Ä–µ–∂–∏–º—É.")

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –≤–æ–¥–µ
def send_water_reminder():
    global last_reminder_message
    if last_chat_id:
        # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º
        message = random.choice([msg for msg in reminder_messages if msg != last_reminder_message])
        last_reminder_message = message  # –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        bot.send_message(last_chat_id, message)
        # –î–æ–±–∞–≤–ª—è–µ–º inline –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        markup = telebot.types.InlineKeyboardMarkup()
        confirm_button = telebot.types.InlineKeyboardButton("‚úÖ –í—ã–ø–∏–ª –≤–æ–¥—É", callback_data="confirm_water")
        markup.add(confirm_button)
        bot.send_message(last_chat_id, "–ù–µ –∂—É–ª—å–Ω–∏—á–∞–π, —Å–æ–ª–Ω—ã—à–∫–æ. –ù–∞–∂–º–∏ —Ç–æ–≥–¥–∞, –∫–æ–≥–¥–∞ –≤—ã–ø–∏–ª–∞ –≤–æ–¥–∏—á–∫–∏", reply_markup=markup)

        # –ï—Å–ª–∏ –Ω–µ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
        if not test_mode:
            # –ó–∞–ø–ª–∞–Ω–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Å–ª–µ–¥—É—é—â–µ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞
            schedule.every(2).hours.do(send_water_reminder)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ —Ç–∞–±–ª–µ—Ç–∫–µ
def send_tablet_reminder():
    if last_chat_id:
        markup = telebot.types.InlineKeyboardMarkup()
        confirm_button = telebot.types.InlineKeyboardButton("‚úÖ –¢–∞–±–ª–µ—Ç–∫—É –≤—ã–ø–∏–ª–∞", callback_data="confirm_tablet")
        markup.add(confirm_button)
        bot.send_message(last_chat_id, tablet_message, reply_markup=markup)

        # –ï—Å–ª–∏ –Ω–µ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
        if not test_mode:
            # –ó–∞–ø–ª–∞–Ω–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Å–ª–µ–¥—É—é—â–µ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç, –µ—Å–ª–∏ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ
            schedule.every().day.at("12:00").do(send_tablet_reminder)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É –¥–ª—è –≤–æ–¥—ã
@bot.callback_query_handler(func=lambda call: call.data == "confirm_water")
def handle_confirmation(call):
    if call.message:
        bot.send_message(call.message.chat.id, "–¢—ã —É –º–µ–Ω—è —Å–∞–º–∞—è –ª—É—á—à–∞—è! üòä")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É –¥–ª—è —Ç–∞–±–ª–µ—Ç–∫–∏
@bot.callback_query_handler(func=lambda call: call.data == "confirm_tablet")
def handle_tablet_confirmation(call):
    if call.message:
        bot.send_message(call.message.chat.id, "–ü—Ä–æ—Å—Ç–æ —É–º–Ω–∏—á–∫–∞! –ù–µ –∑–∞–±—É–¥—å –æ—Ç–º–µ—Ç–∏—Ç—å –≤ —Å–≤–æ—ë–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏, —á—Ç–æ–±—ã –Ω–µ –∑–∞–±—ã—Ç—å üòä")

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
def run_schedule():
    while True:
        schedule.run_pending()
        time.sleep(1)

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ç–æ–∫ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
Thread(target=run_schedule).start()

# –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
load_user_states()
bot.polling(none_stop=True)